<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Context</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen">
    <div class="bg-gray-700 p-8 rounded-lg shadow-lg w-1/3 text-white">
        <h2 class="text-2xl font-bold mb-6">Reset Context</h2>
        
        <label class="block mb-2 text-lg">Router Key:</label>
        <input type="text" id="authKey" class="w-full p-3 border rounded mb-4 text-black" placeholder="Digite a Auth Key">
        
        <label class="block mb-2 text-lg">Contrato:</label>
        <input type="text" id="contract" class="w-full p-3 border rounded mb-4 text-black" placeholder="Digite o Contrato">
        
        <label class="block mb-2 text-lg">Identify:</label>
        <input type="text" id="identify" class="w-full p-3 border rounded mb-4 text-black" placeholder="Digite o Identify">
        
        <button id="resetBtn" class="w-full bg-red-500 text-white py-3 rounded hover:bg-red-600 text-lg">RESET</button>
        
        <div id="log" class="mt-6 text-lg text-green-400 font-bold text-center"></div>
    </div>

    <script>
        async function fetchData(authKey, contract, identify) {
            const url = `https://${contract}.http.msging.net/commands`;
            
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': authKey
            };
            
            const body = {
                "id": generateRandomId(),
                "method": "get",
                "uri": `/contexts/${identify}?withContextValues=true&$take=1000`
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (data.resource && Array.isArray(data.resource.items)) {
                    const names = data.resource.items.map(item => item.name);
                    
                    for (const name of names) {
                        await deleteName(authKey, contract, identify, name);
                    }
                }
                
                await deleteUserContext(authKey, contract, identify);
                
                document.getElementById("log").innerHTML = "PROCESSO FINALIZADO!";
                setTimeout(() => {
                    document.getElementById("log").innerHTML = "";
                }, 4000);
            } catch (error) {
                document.getElementById("log").innerHTML = "Erro ao buscar dados.";
            }
        }

        async function deleteName(authKey, contract, identify, name) {
            const url = `https://${contract}.http.msging.net/commands`;
            
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': authKey
            };
            
            const body = {
                "id": generateRandomId(),
                "method": "delete",
                "uri": `/contexts/${identify}/${encodeURIComponent(name)}`
            };
            
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
            } catch (error) {
                console.error(`Erro ao deletar ${name}:`, error);
            }
        }

        async function deleteUserContext(authKey, contract, identify) {
            const url = `https://${contract}.http.msging.net/commands`;
            
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': authKey
            };
            
            const body = {
                "id": generateRandomId(),
                "method": "delete",
                "uri": `/contacts/${identify}`
            };
            
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
            } catch (error) {
                console.error(`Erro ao deletar contexto do usu√°rio:`, error);
            }
        }

        function generateRandomId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        document.getElementById("resetBtn").addEventListener("click", () => {
            const authKey = document.getElementById("authKey").value;
            const contract = document.getElementById("contract").value;
            const identify = document.getElementById("identify").value;
            if (authKey && contract && identify) {
                fetchData(authKey, contract, identify);
            } else {
                alert("Preencha todos os campos!");
            }
        });
    </script>
</body>
</html>
